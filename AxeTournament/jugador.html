<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NOVURAXE â€” Portal del Jugador</title>
<link rel="icon" type="image/png" href="public/dataxe-simple.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
:root {
  --bg:       #1a1410;
  --bg2:      #2c2418;
  --bg3:      #3e3025;
  --ink:      #fdfaf7;
  --ink2:     #f0ebe3;
  --ink3:     #b5a898;
  --ink4:     #6b5d4e;
  --line:     rgba(255,255,255,0.08);
  --line2:    rgba(255,255,255,0.14);
  --accent:   #c4873a;
  --accent2:  #d4975a;
  --accent-bg:rgba(196,135,58,0.12);
  --accent-ln:rgba(196,135,58,0.3);
  --sand:     #c4a96a;
  --sand-bg:  rgba(196,169,106,0.12);
  --green:    #6ab187;
  --green-bg: rgba(74,124,89,0.15);
  --red:      #d4635a;
  --red-bg:   rgba(184,64,64,0.15);
  --r:  8px;
  --r2: 12px;
  --sh: 0 2px 12px rgba(0,0,0,0.35);
  --sh2: 0 8px 32px rgba(0,0,0,0.5);
  --f: 'Montserrat', sans-serif;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }

body {
  font-family: var(--f);
  background: var(--bg);
  color: var(--ink);
  font-size: 14px;
  line-height: 1.5;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

body::before {
  content: '';
  position: fixed; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events: none; z-index: 0; opacity: 0.3;
}

::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: #1a1410; }
::-webkit-scrollbar-thumb { background: rgba(196,135,58,0.3); border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent); }

button { cursor: pointer; font-family: inherit; }
input, textarea, select { font-family: inherit; }

/* â”€â”€ SCREENS â”€â”€ */
.screen { display: none; min-height: 100vh; }
.screen.on { display: flex; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#scr-login {
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 2rem;
  background: linear-gradient(160deg, #2c2418 0%, #1a1410 60%);
  position: relative;
  overflow: hidden;
}
#scr-login::before {
  content: '';
  position: absolute;
  width: 600px; height: 600px;
  background: radial-gradient(ellipse, rgba(196,135,58,0.07) 0%, transparent 70%);
  top: -200px; right: -200px;
  pointer-events: none;
}

.login-logo {
  display: flex; flex-direction: column; align-items: center;
  margin-bottom: 2rem; position: relative; z-index: 1;
}
.login-logo img { height: 52px; width: auto; filter: brightness(0) invert(1); }
.login-logo-sub {
  font-size: 9px; font-weight: 700; letter-spacing: 3px;
  text-transform: uppercase; color: var(--accent); margin-top: 8px;
}
.login-role-tag {
  font-size: 9px; font-weight: 700; letter-spacing: 2px;
  text-transform: uppercase; color: var(--ink4);
  border: 1px solid rgba(255,255,255,0.1);
  padding: 4px 12px; border-radius: 20px; margin-top: 6px;
}

.login-box {
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: var(--r2);
  padding: 2rem;
  width: 100%; max-width: 400px;
  position: relative; z-index: 1;
  backdrop-filter: blur(8px);
}

.l-tabs {
  display: flex; gap: 4px;
  background: rgba(255,255,255,0.05);
  border-radius: var(--r); padding: 4px;
  margin-bottom: 1.5rem;
}
.l-tab {
  flex: 1; font-size: 12px; font-weight: 700;
  letter-spacing: 0.5px; text-transform: uppercase;
  background: transparent; border: none;
  color: var(--ink4); padding: 8px;
  border-radius: calc(var(--r) - 2px);
  transition: all 0.2s;
}
.l-tab.on { background: var(--accent); color: #fff; }

.field { margin-bottom: 1rem; }
.f-label {
  display: block; font-size: 10px; font-weight: 700;
  letter-spacing: 1px; text-transform: uppercase;
  color: var(--ink4); margin-bottom: 6px;
}
.f-input {
  width: 100%; background: rgba(255,255,255,0.05);
  border: 1.5px solid rgba(255,255,255,0.1);
  border-radius: var(--r); color: var(--ink);
  font-size: 14px; padding: 0.65rem 0.875rem;
  outline: none; transition: all 0.15s;
}
.f-input:focus { border-color: var(--accent); background: rgba(255,255,255,0.08); box-shadow: 0 0 0 3px rgba(196,135,58,0.15); }
.f-input::placeholder { color: var(--ink4); }

.pass-wrap { position: relative; }
.pass-wrap .f-input { padding-right: 2.5rem; }
.pass-eye {
  position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
  background: none; border: none; color: var(--ink4); font-size: 14px;
  transition: color 0.2s;
}
.pass-eye:hover { color: var(--ink3); }

.err-msg { font-size: 12px; color: var(--red); margin-bottom: 0.75rem; display: none; font-weight: 500; }

.btn-full {
  width: 100%; font-size: 12px; font-weight: 700;
  letter-spacing: 1.5px; text-transform: uppercase;
  background: var(--accent); color: #1a1410;
  border: none; border-radius: var(--r);
  padding: 12px; transition: all 0.2s;
}
.btn-full:hover { background: var(--accent2); transform: translateY(-1px); box-shadow: 0 6px 20px rgba(196,135,58,0.35); }

.link-small {
  font-size: 11px; color: var(--ink4);
  cursor: pointer; text-decoration: underline;
  text-underline-offset: 3px; background: none; border: none;
  transition: color 0.2s;
}
.link-small:hover { color: var(--ink3); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP SHELL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#scr-app {
  flex-direction: column;
  min-height: 100vh;
  background: transparent;
  position: relative; z-index: 1;
}

/* TOPBAR */
.topbar {
  position: sticky; top: 0; z-index: 200;
  height: 60px;
  background: rgba(26,20,16,0.92);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid rgba(196,135,58,0.15);
  display: flex; align-items: center;
  padding: 0 1.5rem; gap: 1rem;
  box-shadow: 0 1px 20px rgba(0,0,0,0.4);
}
.t-logo img { height: 30px; width: auto; filter: brightness(0) invert(1); }
.t-sep { width: 1px; height: 22px; background: rgba(255,255,255,0.1); flex-shrink: 0; }
.t-role-badge {
  font-size: 9px; font-weight: 700; letter-spacing: 1.5px;
  text-transform: uppercase; color: var(--accent);
  border: 1px solid rgba(196,135,58,0.3);
  padding: 3px 10px; border-radius: 20px;
}
.t-nav { display: flex; gap: 2px; }
.t-nav-btn {
  font-size: 12px; font-weight: 500; color: var(--ink4);
  background: transparent; border: none;
  border-radius: var(--r); padding: 6px 12px;
  transition: all 0.15s;
}
.t-nav-btn:hover { background: rgba(255,255,255,0.08); color: var(--ink); }
.t-nav-btn.on { background: rgba(196,135,58,0.15); color: var(--accent); font-weight: 700; }
.t-right { margin-left: auto; display: flex; align-items: center; gap: 0.75rem; }
.t-username { font-size: 12px; font-weight: 600; color: var(--ink3); }

/* BUTTONS */
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  font-size: 12px; font-weight: 700; letter-spacing: 0.3px;
  padding: 8px 16px; border-radius: var(--r);
  border: none; cursor: pointer; transition: all 0.15s;
  white-space: nowrap;
}
.btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
.btn-accent { background: var(--accent); color: #1a1410; }
.btn-ghost {
  background: transparent; color: var(--ink3);
  border: 1.5px solid rgba(255,255,255,0.15);
}
.btn-ghost:hover { border-color: rgba(255,255,255,0.3); background: rgba(255,255,255,0.07); }
.btn-sm { font-size: 11px; padding: 6px 12px; }
.btn-danger { background: var(--red); color: #fff; }

/* LAYOUT */
.content { max-width: 1100px; margin: 0 auto; padding: 2rem 1.5rem; }
.page { display: none; }
.page.on { display: block; }

/* PAGE HEADER */
.pg-eyebrow {
  font-size: 10px; font-weight: 700; letter-spacing: 3px;
  text-transform: uppercase; color: var(--accent);
  display: flex; align-items: center; gap: 8px; margin-bottom: 6px;
}
.pg-eyebrow::before { content: ''; width: 20px; height: 1px; background: var(--accent); }
.pg-title {
  font-size: 1.6rem; font-weight: 800; letter-spacing: 1px;
  text-transform: uppercase; color: var(--ink);
  line-height: 1.1; margin-bottom: 4px;
}
.pg-title em { color: var(--accent); font-style: normal; }
.pg-sub { font-size: 11px; color: var(--ink4); letter-spacing: 0.5px; margin-bottom: 2rem; }

/* CARDS */
.card {
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: var(--r2); padding: 1.375rem;
  box-shadow: var(--sh); transition: all 0.2s;
}
.card:hover { border-color: rgba(196,135,58,0.2); }
.card-title {
  font-size: 10px; font-weight: 700; letter-spacing: 2px;
  text-transform: uppercase; color: var(--ink4); margin-bottom: 1rem;
}

/* GRID */
.g2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
.g3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
.g4 { display: grid; grid-template-columns: repeat(4,1fr); gap: 0.875rem; }

/* STAT CARDS */
.stat-card {
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: var(--r2); padding: 1.25rem 1.375rem;
  transition: all 0.2s;
}
.stat-card:hover { border-color: rgba(196,135,58,0.3); background: rgba(196,135,58,0.06); }
.stat-n {
  font-size: 2rem; font-weight: 800; color: var(--accent);
  line-height: 1; letter-spacing: -1px;
}
.stat-n.green { color: var(--green); }
.stat-n.sand  { color: var(--sand); }
.stat-l {
  font-size: 10px; font-weight: 600; color: var(--ink4);
  letter-spacing: 1px; text-transform: uppercase; margin-top: 4px;
}

/* BADGE */
.badge {
  display: inline-flex; align-items: center; gap: 3px;
  font-size: 9px; font-weight: 700; letter-spacing: 0.8px;
  text-transform: uppercase; padding: 3px 9px; border-radius: 20px;
}
.badge-open   { background: var(--green-bg); color: var(--green); }
.badge-full   { background: var(--red-bg); color: var(--red); }
.badge-done   { background: rgba(255,255,255,0.06); color: var(--ink4); }
.badge-cancel { background: var(--red-bg); color: var(--red); }
.badge-soon   { background: var(--accent-bg); color: var(--accent); }

/* DIVIDER */
.divider { height: 1px; background: rgba(255,255,255,0.07); margin: 1.25rem 0; }

/* EMPTY STATE */
.empty {
  text-align: center; padding: 4rem 2rem;
  color: var(--ink4); font-size: 13px;
}
.empty-icon { font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.4; }
.empty-title { font-weight: 700; color: var(--ink3); margin-bottom: 6px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FEED PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.feed-filters {
  display: flex; gap: 8px; margin-bottom: 1.5rem; flex-wrap: wrap;
}
.filter-btn {
  font-size: 11px; font-weight: 600; letter-spacing: 0.5px;
  padding: 6px 14px; border-radius: 20px;
  border: 1.5px solid rgba(255,255,255,0.1);
  background: transparent; color: var(--ink4);
  transition: all 0.15s;
}
.filter-btn:hover { border-color: var(--accent); color: var(--accent); }
.filter-btn.on { background: var(--accent); border-color: var(--accent); color: #1a1410; }

.event-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem; }

.event-card {
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: var(--r2); overflow: hidden;
  transition: all 0.2s; cursor: pointer;
}
.event-card:hover { border-color: rgba(196,135,58,0.35); transform: translateY(-2px); box-shadow: var(--sh2); }
.event-card-accent { height: 3px; background: var(--accent); }
.event-card-body { padding: 1.25rem; }
.event-card-top {
  display: flex; align-items: flex-start;
  justify-content: space-between; gap: 0.75rem; margin-bottom: 0.75rem;
}
.event-card-title {
  font-size: 14px; font-weight: 700; color: var(--ink); line-height: 1.3;
}
.event-card-club {
  font-size: 11px; color: var(--ink4); margin-top: 3px;
}
.event-meta {
  display: flex; flex-wrap: wrap; gap: 0.5rem 1rem; margin-top: 0.875rem;
}
.event-meta-item {
  font-size: 11px; color: var(--ink3);
  display: flex; align-items: center; gap: 5px;
}
.event-meta-item span { color: var(--ink4); }
.event-card-footer {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.75rem 1.25rem;
  background: rgba(255,255,255,0.03);
  border-top: 1px solid rgba(255,255,255,0.06);
}
.event-spots {
  font-size: 11px; color: var(--ink4);
}
.event-spots strong { color: var(--ink3); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ORGANIZADORES PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.org-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }

.org-card {
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: var(--r2); padding: 1.25rem;
  display: flex; flex-direction: column; gap: 1rem;
  transition: all 0.2s;
}
.org-card:hover { border-color: rgba(196,135,58,0.25); }
.org-card-top { display: flex; gap: 1rem; align-items: center; }
.org-avatar {
  width: 48px; height: 48px; border-radius: 10px;
  background: var(--bg3); border: 1px solid rgba(255,255,255,0.1);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.4rem; overflow: hidden; flex-shrink: 0;
}
.org-avatar img { width: 100%; height: 100%; object-fit: contain; }
.org-name { font-size: 14px; font-weight: 700; color: var(--ink); }
.org-username { font-size: 11px; color: var(--ink4); margin-top: 2px; }
.org-stats {
  display: flex; gap: 1rem;
  border-top: 1px solid rgba(255,255,255,0.06);
  padding-top: 0.875rem;
}
.org-stat { text-align: center; }
.org-stat-n { font-size: 1.1rem; font-weight: 800; color: var(--accent); }
.org-stat-l { font-size: 9px; color: var(--ink4); letter-spacing: 1px; text-transform: uppercase; margin-top: 2px; }

.follow-btn {
  width: 100%; font-size: 11px; font-weight: 700; letter-spacing: 1px;
  text-transform: uppercase; padding: 8px;
  border-radius: var(--r); border: none; transition: all 0.2s;
}
.follow-btn.following {
  background: rgba(255,255,255,0.06);
  border: 1.5px solid rgba(255,255,255,0.12);
  color: var(--ink3);
}
.follow-btn.following:hover { background: var(--red-bg); border-color: var(--red); color: var(--red); }
.follow-btn.not-following { background: var(--accent); color: #1a1410; }
.follow-btn.not-following:hover { background: var(--accent2); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATS PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stats-layout { display: grid; grid-template-columns: 300px 1fr; gap: 1.5rem; }

.profile-card {
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: var(--r2); padding: 1.5rem;
  text-align: center;
}
.profile-avatar {
  width: 72px; height: 72px; border-radius: 50%;
  background: var(--bg3); border: 2px solid rgba(196,135,58,0.3);
  display: flex; align-items: center; justify-content: center;
  font-size: 2rem; margin: 0 auto 1rem;
}
.profile-name { font-size: 1.1rem; font-weight: 800; color: var(--ink); }
.profile-username { font-size: 11px; color: var(--accent); margin-top: 3px; letter-spacing: 0.5px; }
.profile-since { font-size: 10px; color: var(--ink4); margin-top: 6px; }

.profile-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 1.25rem; }
.profile-stat {
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.07);
  border-radius: var(--r); padding: 0.75rem;
  text-align: center;
}
.profile-stat-n { font-size: 1.4rem; font-weight: 800; color: var(--accent); line-height: 1; }
.profile-stat-l { font-size: 9px; color: var(--ink4); letter-spacing: 1px; text-transform: uppercase; margin-top: 3px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HISTORIAL PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hist-table { width: 100%; border-collapse: collapse; }
.hist-table th {
  font-size: 9px; font-weight: 700; letter-spacing: 2px;
  text-transform: uppercase; color: var(--ink4);
  text-align: left; padding: 9px 14px;
  border-bottom: 2px solid rgba(255,255,255,0.08);
  background: rgba(255,255,255,0.04);
}
.hist-table td {
  padding: 12px 14px;
  border-bottom: 1px solid rgba(255,255,255,0.06);
  font-size: 13px; color: var(--ink3);
}
.hist-table tr:last-child td { border-bottom: none; }
.hist-table tr:hover td { background: rgba(196,135,58,0.04); }
.hist-name { font-weight: 700; color: var(--ink); }
.hist-pos {
  font-size: 1.1rem; font-weight: 800; color: var(--ink4);
}
.hist-pos.p1 { color: #c4873a; }
.hist-pos.p2 { color: #8c8c8c; }
.hist-pos.p3 { color: #92400e; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,0.75); z-index: 500;
  align-items: center; justify-content: center; padding: 1rem;
  backdrop-filter: blur(4px);
}
.modal-overlay.on { display: flex; }
.modal {
  background: #2a2018;
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: calc(var(--r2) + 4px);
  padding: 1.75rem; width: 100%;
  max-width: 480px; max-height: 90vh; overflow-y: auto;
  box-shadow: var(--sh2);
}
.modal-title {
  font-size: 1rem; font-weight: 800; letter-spacing: 0.5px;
  text-transform: uppercase; color: var(--ink);
  margin-bottom: 1.25rem;
}
.modal-footer {
  display: flex; gap: 0.75rem; justify-content: flex-end;
  margin-top: 1.25rem; padding-top: 1.25rem;
  border-top: 1px solid rgba(255,255,255,0.07);
}

/* TOAST */
.toast {
  position: fixed; bottom: 1.5rem; left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: #2a2018; border: 1px solid rgba(196,135,58,0.3);
  color: var(--ink); padding: 10px 20px;
  border-radius: 20px; font-size: 12px; font-weight: 600;
  z-index: 1000; transition: transform 0.3s;
  pointer-events: none; white-space: nowrap;
}
.toast.show { transform: translateX(-50%) translateY(0); }

/* LOADING */
.loading {
  display: flex; align-items: center; justify-content: center;
  padding: 3rem; color: var(--ink4); gap: 10px;
}
.spinner {
  width: 18px; height: 18px;
  border: 2px solid rgba(255,255,255,0.1);
  border-top-color: var(--accent);
  border-radius: 50%; animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* MOBILE NAV */
.mob-nav {
  display: none; position: fixed; bottom: 0; left: 0; right: 0;
  background: rgba(26,20,16,0.96); backdrop-filter: blur(12px);
  border-top: 1px solid rgba(255,255,255,0.08);
  padding: 0.5rem; z-index: 200;
  justify-content: space-around;
}
.mob-btn {
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  background: none; border: none; color: var(--ink4);
  font-size: 9px; font-weight: 700; letter-spacing: 1px;
  text-transform: uppercase; padding: 6px 12px; border-radius: var(--r);
  transition: all 0.15s;
}
.mob-btn .icon { font-size: 1.1rem; }
.mob-btn.on { color: var(--accent); }
.mob-btn.on .icon { filter: drop-shadow(0 0 4px rgba(196,135,58,0.5)); }

@media (max-width: 768px) {
  .topbar .t-nav { display: none; }
  .mob-nav { display: flex; }
  .content { padding: 1.5rem 1rem 5rem; }
  .stats-layout { grid-template-columns: 1fr; }
  .g4 { grid-template-columns: repeat(2,1fr); }
  .g3 { grid-template-columns: 1fr 1fr; }
  .g2 { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- â•â• LOGIN â•â• -->
<div class="screen on" id="scr-login">
  <div class="login-logo">
    <img src="public/novuraxe-logo.png" alt="NOVURAXE">
    <div class="login-logo-sub">GestiÃ³n de Torneos</div>
    <div class="login-role-tag">Portal del Jugador</div>
  </div>

  <div class="login-box">
    <div class="l-tabs">
      <button class="l-tab on" id="lt-login" onclick="switchTab('login')">Iniciar sesiÃ³n</button>
      <button class="l-tab" id="lt-reg" onclick="switchTab('reg')">Registrarse</button>
    </div>

    <!-- LOGIN -->
    <div id="pn-login">
      <div class="err-msg" id="err-login"></div>
      <div class="field">
        <label class="f-label">Email</label>
        <input class="f-input" type="email" id="l-email" placeholder="tu@email.com" autocomplete="email">
      </div>
      <div class="field">
        <label class="f-label">ContraseÃ±a</label>
        <div class="pass-wrap">
          <input class="f-input" type="password" id="l-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
          <button class="pass-eye" onclick="togglePass('l-pass',this)">ğŸ‘</button>
        </div>
      </div>
      <button class="btn-full" onclick="doLogin()" style="margin-bottom:0.75rem">Entrar</button>
      <div style="text-align:center">
        <button class="link-small" onclick="switchTab('forgot')">Â¿Olvidaste tu contraseÃ±a?</button>
      </div>
    </div>

    <!-- FORGOT -->
    <div id="pn-forgot" style="display:none">
      <div class="err-msg" id="err-forgot"></div>
      <div class="field">
        <label class="f-label">Email</label>
        <input class="f-input" type="email" id="f-email" placeholder="tu@email.com">
      </div>
      <button class="btn-full" onclick="doForgot()" style="margin-bottom:0.75rem">Enviar enlace</button>
      <div style="text-align:center">
        <button class="link-small" onclick="switchTab('login')">â† Volver al login</button>
      </div>
    </div>

    <!-- REGISTER -->
    <div id="pn-reg" style="display:none">
      <div class="err-msg" id="err-reg"></div>
      <div class="field">
        <label class="f-label">Nombre</label>
        <input class="f-input" type="text" id="r-name" placeholder="Tu nombre completo">
      </div>
      <div class="field">
        <label class="f-label">Usuario</label>
        <input class="f-input" type="text" id="r-user" placeholder="@usuario">
      </div>
      <div class="field">
        <label class="f-label">Email</label>
        <input class="f-input" type="email" id="r-email" placeholder="tu@email.com">
      </div>
      <div class="field">
        <label class="f-label">ContraseÃ±a</label>
        <div class="pass-wrap">
          <input class="f-input" type="password" id="r-pass" placeholder="MÃ­nimo 6 caracteres">
          <button class="pass-eye" onclick="togglePass('r-pass',this)">ğŸ‘</button>
        </div>
      </div>
      <button class="btn-full" onclick="doRegister()">Crear cuenta de jugador</button>
    </div>
  </div>
</div>

<!-- â•â• APP â•â• -->
<div class="screen" id="scr-app">

  <!-- Topbar -->
  <div class="topbar">
    <div class="t-logo">
      <img src="public/novuraxe-logo.png" alt="NOVURAXE">
    </div>
    <div class="t-sep"></div>
    <div class="t-role-badge">Jugador</div>
    <div class="t-sep"></div>
    <nav class="t-nav">
      <button class="t-nav-btn on" data-page="feed" onclick="showPage('feed')">ğŸ† Feed</button>
      <button class="t-nav-btn" data-page="orgs" onclick="showPage('orgs')">ğŸŸ Organizadores</button>
      <button class="t-nav-btn" data-page="stats" onclick="showPage('stats')">ğŸ“Š Mis stats</button>
      <button class="t-nav-btn" data-page="history" onclick="showPage('history')">ğŸ“ Historial</button>
    </nav>
    <div class="t-right">
      <span class="t-username" id="t-username"></span>
      <button class="btn btn-ghost btn-sm" onclick="doLogout()">Salir</button>
    </div>
  </div>

  <!-- Mobile bottom nav -->
  <nav class="mob-nav">
    <button class="mob-btn on" data-page="feed" onclick="showPage('feed')">
      <span class="icon">ğŸ†</span>Feed
    </button>
    <button class="mob-btn" data-page="orgs" onclick="showPage('orgs')">
      <span class="icon">ğŸŸ</span>Clubs
    </button>
    <button class="mob-btn" data-page="stats" onclick="showPage('stats')">
      <span class="icon">ğŸ“Š</span>Stats
    </button>
    <button class="mob-btn" data-page="history" onclick="showPage('history')">
      <span class="icon">ğŸ“</span>Historial
    </button>
  </nav>

  <div class="content">

    <!-- â”€â”€ FEED â”€â”€ -->
    <div class="page on" id="pg-feed">
      <div class="pg-eyebrow">PrÃ³ximos torneos</div>
      <h1 class="pg-title">Tu <em>feed.</em></h1>
      <p class="pg-sub">Torneos de los organizadores que sigues</p>

      <div class="feed-filters">
        <button class="filter-btn on" onclick="setFilter('all',this)">Todos</button>
        <button class="filter-btn" onclick="setFilter('open',this)">InscripciÃ³n abierta</button>
        <button class="filter-btn" onclick="setFilter('soon',this)">Esta semana</button>
        <button class="filter-btn" onclick="setFilter('following',this)">Solo mis clubs</button>
      </div>

      <div id="feed-list">
        <div class="loading"><div class="spinner"></div> Cargando torneos...</div>
      </div>
    </div>

    <!-- â”€â”€ ORGANIZADORES â”€â”€ -->
    <div class="page" id="pg-orgs">
      <div class="pg-eyebrow">Descubrir</div>
      <h1 class="pg-title">Clubs &amp; <em>Organizadores.</em></h1>
      <p class="pg-sub">Sigue a los organizadores para ver sus torneos en tu feed</p>

      <div style="margin-bottom:1.25rem">
        <input class="f-input" type="text" id="org-search"
          placeholder="ğŸ”  Buscar por nombre de club..."
          oninput="filterOrgs(this.value)"
          style="max-width:360px">
      </div>

      <div id="orgs-list">
        <div class="loading"><div class="spinner"></div> Cargando organizadores...</div>
      </div>
    </div>

    <!-- â”€â”€ MIS STATS â”€â”€ -->
    <div class="page" id="pg-stats">
      <div class="pg-eyebrow">Mi perfil</div>
      <h1 class="pg-title">Mis <em>estadÃ­sticas.</em></h1>
      <p class="pg-sub">Tu historial en torneos registrados en NOVURAXE</p>

      <div class="stats-layout" id="stats-layout">
        <div class="loading"><div class="spinner"></div> Cargando...</div>
      </div>
    </div>

    <!-- â”€â”€ HISTORIAL â”€â”€ -->
    <div class="page" id="pg-history">
      <div class="pg-eyebrow">Historial</div>
      <h1 class="pg-title">Torneos <em>jugados.</em></h1>
      <p class="pg-sub">Torneos en los que apareces registrado</p>

      <div id="history-list">
        <div class="loading"><div class="spinner"></div> Cargando historial...</div>
      </div>
    </div>

  </div><!-- content -->
</div><!-- scr-app -->

<!-- â•â• MODAL EVENTO â•â• -->
<div class="modal-overlay" id="m-event">
  <div class="modal">
    <div class="modal-title" id="m-event-title">Detalle del torneo</div>
    <div id="m-event-body"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('m-event')">Cerrar</button>
      <button class="btn btn-accent" id="m-event-reg-btn" onclick="registerToEvent()">Inscribirme</button>
    </div>
  </div>
</div>

<!-- â•â• MODAL RESET PASS â•â• -->
<div class="modal-overlay on" id="m-reset" style="display:none">
  <div class="modal" style="max-width:360px">
    <div class="modal-title">Nueva contraseÃ±a</div>
    <div class="field">
      <label class="f-label">ContraseÃ±a nueva</label>
      <input class="f-input" type="password" id="new-pass" placeholder="MÃ­nimo 6 caracteres">
    </div>
    <button class="btn-full" onclick="confirmReset()">Guardar contraseÃ±a</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPA_URL = 'https://ofdxzysrjswalekwjazl.supabase.co';
const SUPA_KEY = 'sb_publishable_ec6m8rEqcPSZyMvf7SMYag_-8GMIAc3';
const sb = window.supabase.createClient(SUPA_URL, SUPA_KEY);

let CUR_USER   = null; // auth user object
let PROFILE    = null; // public.users row
let ALL_EVENTS = [];
let ALL_ORGS   = [];
let FOLLOWS    = new Set();
let FILTER     = 'all';
let ACTIVE_EVENT = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, ms = 2500) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), ms);
}

function showErr(id, msg) {
  const el = document.getElementById(id);
  el.textContent = msg; el.style.display = 'block';
}
function clearErrs() {
  document.querySelectorAll('.err-msg').forEach(e => e.style.display = 'none');
}

function openModal(id)  { document.getElementById(id).classList.add('on'); }
function closeModal(id) { document.getElementById(id).classList.remove('on'); }

function fmtDate(d) {
  if (!d) return 'â€”';
  return new Date(d).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
}
function daysUntil(d) {
  if (!d) return null;
  const diff = Math.ceil((new Date(d) - new Date()) / 86400000);
  return diff;
}

function statusBadge(status, date) {
  const days = daysUntil(date);
  if (status === 'cancelled') return '<span class="badge badge-cancel">Cancelado</span>';
  if (status === 'done')      return '<span class="badge badge-done">Finalizado</span>';
  if (status === 'full')      return '<span class="badge badge-full">Completo</span>';
  if (days !== null && days >= 0 && days <= 7) return '<span class="badge badge-soon">Esta semana</span>';
  return '<span class="badge badge-open">InscripciÃ³n abierta</span>';
}

async function dbGet(path) {
  const session = (await sb.auth.getSession()).data.session;
  const token = session?.access_token || SUPA_KEY;
  const res = await fetch(`${SUPA_URL}/rest/v1/${path}`, {
    headers: {
      'apikey': SUPA_KEY,
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
    }
  });
  if (!res.ok) return [];
  return res.json();
}

async function dbPost(table, body) {
  const session = (await sb.auth.getSession()).data.session;
  const token = session?.access_token || SUPA_KEY;
  return fetch(`${SUPA_URL}/rest/v1/${table}`, {
    method: 'POST',
    headers: {
      'apikey': SUPA_KEY,
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
      'Prefer': 'return=representation'
    },
    body: JSON.stringify(body)
  });
}

async function dbDelete(table, filter) {
  const session = (await sb.auth.getSession()).data.session;
  const token = session?.access_token || SUPA_KEY;
  return fetch(`${SUPA_URL}/rest/v1/${table}?${filter}`, {
    method: 'DELETE',
    headers: {
      'apikey': SUPA_KEY,
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(t) {
  clearErrs();
  ['login','reg','forgot'].forEach(p => {
    document.getElementById('pn-'+p).style.display = 'none';
  });
  document.getElementById('pn-'+t).style.display = 'block';
  document.querySelectorAll('.l-tab').forEach(b => b.classList.remove('on'));
  const map = { login:'lt-login', reg:'lt-reg', forgot:'lt-login' };
  document.getElementById(map[t])?.classList.add('on');
}

function togglePass(id, btn) {
  const inp = document.getElementById(id);
  inp.type = inp.type === 'password' ? 'text' : 'password';
  btn.textContent = inp.type === 'password' ? 'ğŸ‘' : 'ğŸ™ˆ';
}

async function doLogin() {
  clearErrs();
  const email = document.getElementById('l-email').value.trim();
  const pass  = document.getElementById('l-pass').value;
  if (!email || !pass) return showErr('err-login', 'Rellena todos los campos');
  const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
  if (error) return showErr('err-login', 'Email o contraseÃ±a incorrectos');
  await launchApp(data.user);
}

async function doRegister() {
  clearErrs();
  const name  = document.getElementById('r-name').value.trim();
  const user  = document.getElementById('r-user').value.trim().replace('@','');
  const email = document.getElementById('r-email').value.trim();
  const pass  = document.getElementById('r-pass').value;
  if (!name || !user || !email || !pass) return showErr('err-reg', 'Rellena todos los campos');
  if (pass.length < 6) return showErr('err-reg', 'La contraseÃ±a debe tener al menos 6 caracteres');
  if (!/^[a-z0-9_]+$/i.test(user)) return showErr('err-reg', 'Usuario solo puede contener letras, nÃºmeros y _');

  const { data, error } = await sb.auth.signUp({
    email, password: pass,
    options: { data: { username: user, full_name: name, role: 'player' } }
  });
  if (error) return showErr('err-reg', error.message);
  await launchApp(data.user);
}

async function doForgot() {
  clearErrs();
  const email = document.getElementById('f-email').value.trim();
  if (!email) return showErr('err-forgot', 'Introduce tu email');
  const { error } = await sb.auth.resetPasswordForEmail(email, {
    redirectTo: window.location.origin + window.location.pathname
  });
  if (error) return showErr('err-forgot', error.message);
  showErr('err-forgot', 'âœ“ Enlace enviado, revisa tu email');
  document.getElementById('err-forgot').style.color = 'var(--green)';
}

(async function checkReset() {
  const hash   = window.location.hash;
  const params = new URLSearchParams(hash.replace('#','?'));
  if (params.get('type') !== 'recovery') return;
  document.getElementById('m-reset').style.display = 'flex';
  document.getElementById('m-reset').classList.add('on');
})();

async function confirmReset() {
  const pass = document.getElementById('new-pass').value;
  if (pass.length < 6) return toast('MÃ­nimo 6 caracteres');
  const { error } = await sb.auth.updateUser({ password: pass });
  if (error) return toast('Error: ' + error.message);
  document.getElementById('m-reset').classList.remove('on');
  history.replaceState(null, '', location.pathname);
  toast('âœ“ ContraseÃ±a actualizada');
}

async function doLogout() {
  await sb.auth.signOut();
  CUR_USER = PROFILE = null;
  FOLLOWS.clear();
  document.getElementById('scr-app').classList.remove('on');
  document.getElementById('scr-login').classList.add('on');
  switchTab('login');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LAUNCH APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function launchApp(user) {
  CUR_USER = user;

  // Load or create profile
  const rows = await dbGet(`users?id=eq.${user.id}&select=*`);
  if (rows.length) {
    PROFILE = rows[0];
  } else {
    // Create profile for new user
    await dbPost('users', {
      id: user.id,
      username: user.user_metadata?.username || user.email.split('@')[0],
      club_name: user.user_metadata?.full_name || ''
    });
    PROFILE = {
      id: user.id,
      username: user.user_metadata?.username || user.email.split('@')[0],
      club_name: user.user_metadata?.full_name || ''
    };
  }

  // Load follows
  const followRows = await dbGet(`follows?follower_id=eq.${user.id}&select=following_id`);
  FOLLOWS = new Set(followRows.map(f => f.following_id));

  // Also load organizers table to verify follow targets exist
  // (follows.following_id references organizers.user_id)

  document.getElementById('t-username').textContent = PROFILE.username || user.email;
  document.getElementById('scr-login').classList.remove('on');
  document.getElementById('scr-app').classList.add('on');

  showPage('feed');
}

// Restore session
(async function restoreSession() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) return;
  await launchApp(session.user);
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(p) {
  document.querySelectorAll('.page').forEach(el => el.classList.remove('on'));
  document.getElementById('pg-' + p)?.classList.add('on');
  document.querySelectorAll('.t-nav-btn, .mob-btn').forEach(el => {
    el.classList.toggle('on', el.dataset.page === p);
  });
  renderPage(p);
}

function renderPage(p) {
  if (p === 'feed')    renderFeed();
  if (p === 'orgs')    renderOrgs();
  if (p === 'stats')   renderStats();
  if (p === 'history') renderHistory();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FEED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadEvents() {
  // Load all public events
  ALL_EVENTS = await dbGet('tournament_events?select=*,organizers(username,club_name,logo_url)&order=date.asc');
}

function setFilter(f, btn) {
  FILTER = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  renderFeed();
}

async function renderFeed() {
  const container = document.getElementById('feed-list');
  container.innerHTML = '<div class="loading"><div class="spinner"></div> Cargando torneos...</div>';

  await loadEvents();

  let events = [...ALL_EVENTS];

  // Apply filter
  const today = new Date(); today.setHours(0,0,0,0);
  if (FILTER === 'open') {
    events = events.filter(e => e.status === 'open' || e.status === null);
  } else if (FILTER === 'soon') {
    const nextWeek = new Date(today); nextWeek.setDate(nextWeek.getDate() + 7);
    events = events.filter(e => {
      const d = new Date(e.date);
      return d >= today && d <= nextWeek;
    });
  } else if (FILTER === 'following') {
    events = events.filter(e => FOLLOWS.has(e.user_id));
  }

  // Only upcoming
  events = events.filter(e => !e.date || new Date(e.date) >= today || e.status === 'open');

  if (!events.length) {
    container.innerHTML = `
      <div class="empty">
        <div class="empty-icon">ğŸ†</div>
        <div class="empty-title">No hay torneos prÃ³ximos</div>
        <p>Sigue organizadores para ver sus torneos en tu feed</p>
      </div>`;
    return;
  }

  container.innerHTML = `<div class="event-grid">${events.map(eventCard).join('')}</div>`;
}

function eventCard(e) {
  const club = e.organizers?.club_name || e.organizers?.username || 'Organizador';
  const days = daysUntil(e.date);
  const daysLabel = days === null ? '' : days === 0 ? 'Â¡Hoy!' : days === 1 ? 'MaÃ±ana' : days > 0 ? `En ${days} dÃ­as` : 'Pasado';
  const isFollowing = FOLLOWS.has(e.user_id);

  return `
  <div class="event-card" onclick="openEvent(${e.id})">
    <div class="event-card-accent" style="background:${isFollowing ? 'var(--accent)' : 'rgba(255,255,255,0.1)'}"></div>
    <div class="event-card-body">
      <div class="event-card-top">
        <div>
          <div class="event-card-title">${e.title}</div>
          <div class="event-card-club">ğŸŸ ${club}</div>
        </div>
        ${statusBadge(e.status, e.date)}
      </div>
      <div class="event-meta">
        ${e.date ? `<div class="event-meta-item">ğŸ“… <span>${fmtDate(e.date)}${daysLabel ? ' Â· ' + daysLabel : ''}</span></div>` : ''}
        ${e.time ? `<div class="event-meta-item">ğŸ• <span>${e.time.slice(0,5)}</span></div>` : ''}
        ${e.location ? `<div class="event-meta-item">ğŸ“ <span>${e.location}</span></div>` : ''}
        ${e.price != null ? `<div class="event-meta-item">ğŸ’¶ <span>${e.price === 0 ? 'Gratis' : e.price + 'â‚¬'}</span></div>` : ''}
      </div>
    </div>
    <div class="event-card-footer">
      <div class="event-spots">
        ${e.spots ? `<strong>${e.spots}</strong> plazas` : 'Plazas ilimitadas'}
      </div>
      <span style="font-size:11px;color:var(--accent)">Ver detalles â†’</span>
    </div>
  </div>`;
}

async function openEvent(id) {
  ACTIVE_EVENT = ALL_EVENTS.find(e => e.id === id);
  if (!ACTIVE_EVENT) return;
  const e = ACTIVE_EVENT;
  const club = e.organizers?.club_name || e.organizers?.username || 'Organizador';

  document.getElementById('m-event-title').textContent = e.title;
  document.getElementById('m-event-body').innerHTML = `
    <div style="margin-bottom:1rem">
      ${statusBadge(e.status, e.date)}
      <div style="margin-top:0.75rem;font-size:13px;color:var(--ink4)">Organizado por <strong style="color:var(--ink3)">${club}</strong></div>
    </div>
    ${e.description ? `<p style="font-size:13px;color:var(--ink3);line-height:1.7;margin-bottom:1rem">${e.description}</p>` : ''}
    <div class="g2" style="gap:0.75rem;margin-bottom:1rem">
      ${e.date ? `<div class="stat-card"><div class="stat-n" style="font-size:1.2rem">${fmtDate(e.date)}</div><div class="stat-l">Fecha</div></div>` : ''}
      ${e.time ? `<div class="stat-card"><div class="stat-n" style="font-size:1.2rem">${e.time.slice(0,5)}</div><div class="stat-l">Hora</div></div>` : ''}
      ${e.location ? `<div class="stat-card" style="grid-column:1/-1"><div class="stat-n" style="font-size:1rem;letter-spacing:0">ğŸ“ ${e.location}</div><div class="stat-l">Lugar</div></div>` : ''}
      ${e.price != null ? `<div class="stat-card"><div class="stat-n" style="font-size:1.2rem">${e.price === 0 ? 'Gratis' : e.price + 'â‚¬'}</div><div class="stat-l">InscripciÃ³n</div></div>` : ''}
      ${e.spots ? `<div class="stat-card"><div class="stat-n" style="font-size:1.2rem">${e.spots}</div><div class="stat-l">Plazas</div></div>` : ''}
    </div>
  `;

  const regBtn = document.getElementById('m-event-reg-btn');
  if (e.status === 'done' || e.status === 'cancelled' || e.status === 'full') {
    regBtn.style.display = 'none';
  } else {
    regBtn.style.display = '';
  }

  openModal('m-event');
}

async function registerToEvent() {
  if (!ACTIVE_EVENT || !CUR_USER) return;
  const res = await dbPost('event_registrations', {
    event_id: ACTIVE_EVENT.id,
    user_id: CUR_USER.id,
    name: PROFILE.club_name || PROFILE.username,
    email: CUR_USER.email,
    status: 'pending'
  });
  closeModal('m-event');
  if (res.ok) {
    toast('âœ“ InscripciÃ³n enviada al organizador');
  } else {
    toast('Error al inscribirse, intÃ©ntalo de nuevo');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ORGANIZADORES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderOrgs() {
  const container = document.getElementById('orgs-list');
  container.innerHTML = '<div class="loading"><div class="spinner"></div> Cargando organizadores...</div>';

  // Load all organizers from dedicated table
  ALL_ORGS = await dbGet('organizers?select=id,user_id,username,club_name,logo_url,description,location,created_at&order=club_name.asc');

  // Load event counts per organizer
  const events = await dbGet('tournament_events?select=user_id');
  const eventCounts = {};
  events.forEach(e => { eventCounts[e.user_id] = (eventCounts[e.user_id] || 0) + 1; });

  ALL_ORGS = ALL_ORGS.map(o => ({ ...o, event_count: eventCounts[o.user_id] || 0 }))
    .filter(o => o.user_id !== CUR_USER?.id); // exclude self

  renderOrgGrid(ALL_ORGS, container);
}

function filterOrgs(q) {
  const container = document.getElementById('orgs-list');
  const filtered = q
    ? ALL_ORGS.filter(o =>
        (o.club_name   || '').toLowerCase().includes(q.toLowerCase()) ||
        (o.username    || '').toLowerCase().includes(q.toLowerCase()) ||
        (o.location    || '').toLowerCase().includes(q.toLowerCase()) ||
        (o.description || '').toLowerCase().includes(q.toLowerCase()))
    : ALL_ORGS;
  renderOrgGrid(filtered, container);
}

function renderOrgGrid(orgs, container) {
  if (!orgs.length) {
    container.innerHTML = `<div class="empty"><div class="empty-icon">ğŸŸ</div><div class="empty-title">No se encontraron organizadores</div></div>`;
    return;
  }
  container.innerHTML = `<div class="org-grid">${orgs.map(orgCard).join('')}</div>`;
}

function orgCard(o) {
  const followId   = o.user_id || o.id;
  const isFollowing = FOLLOWS.has(followId);
  const avatarContent = o.logo_url
    ? `<img src="${o.logo_url}" alt="">`
    : `<span style="font-size:1.4rem">ğŸŸ</span>`;
  const locationHtml = o.location
    ? `<div style="font-size:10px;color:var(--ink4);margin-top:3px">ğŸ“ ${o.location}</div>`
    : '';

  return `
  <div class="org-card" id="org-${followId}">
    <div class="org-card-top">
      <div class="org-avatar">${avatarContent}</div>
      <div>
        <div class="org-name">${o.club_name || o.username}</div>
        <div class="org-username">@${o.username}</div>
        ${locationHtml}
      </div>
    </div>
    ${o.description ? `<div style="font-size:11px;color:var(--ink4);line-height:1.5;border-top:1px solid rgba(255,255,255,0.06);padding-top:0.75rem">${o.description}</div>` : ''}
    <div class="org-stats">
      <div class="org-stat">
        <div class="org-stat-n">${o.event_count}</div>
        <div class="org-stat-l">Torneos</div>
      </div>
      <div class="org-stat">
        <div class="org-stat-n" style="color:${isFollowing ? 'var(--green)' : 'var(--ink4)'}">${isFollowing ? 'âœ“' : 'â€”'}</div>
        <div class="org-stat-l">Siguiendo</div>
      </div>
    </div>
    <button class="follow-btn ${isFollowing ? 'following' : 'not-following'}"
      onclick="toggleFollow('${followId}', this)">
      ${isFollowing ? 'âœ“ Siguiendo' : '+ Seguir'}
    </button>
  </div>`;
}

async function toggleFollow(orgId, btn) {
  if (!CUR_USER) return;
  const isFollowing = FOLLOWS.has(orgId);

  if (isFollowing) {
    await dbDelete('follows', `follower_id=eq.${CUR_USER.id}&following_id=eq.${orgId}`);
    FOLLOWS.delete(orgId);
    btn.className = 'follow-btn not-following';
    btn.textContent = '+ Seguir';
    // Update stat in card
    const statEl = document.querySelector(`#org-${orgId} .org-stat-n:last-of-type`);
    if (statEl) { statEl.textContent = 'â€”'; statEl.style.color = 'var(--ink4)'; }
    toast('Dejaste de seguir al organizador');
  } else {
    await dbPost('follows', { follower_id: CUR_USER.id, following_id: orgId });
    FOLLOWS.add(orgId);
    btn.className = 'follow-btn following';
    btn.textContent = 'âœ“ Siguiendo';
    const statEl = document.querySelector(`#org-${orgId} .org-stat-n:last-of-type`);
    if (statEl) { statEl.textContent = 'âœ“'; statEl.style.color = 'var(--green)'; }
    toast('âœ“ Ahora sigues a este organizador');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MIS STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderStats() {
  const container = document.getElementById('stats-layout');
  container.innerHTML = '<div class="loading"><div class="spinner"></div> Cargando...</div>';
  if (!CUR_USER) return;

  // Check if there are global_stats linked to this user
  const stats = await dbGet(`global_stats?user_id=eq.${CUR_USER.id}&select=*&order=total_qpts.desc`);

  const totalTournaments = stats.reduce((a,s) => a + (s.tournaments || 0), 0);
  const totalWins        = stats.reduce((a,s) => a + (s.wins || 0), 0);
  const totalPts         = stats.reduce((a,s) => a + (s.total_qpts || 0), 0);
  const since            = PROFILE?.created_at ? fmtDate(PROFILE.created_at) : 'â€”';

  container.innerHTML = `
    <div>
      <div class="profile-card">
        <div class="profile-avatar">ğŸ¯</div>
        <div class="profile-name">${PROFILE?.club_name || PROFILE?.username || 'â€”'}</div>
        <div class="profile-username">@${PROFILE?.username || 'â€”'}</div>
        <div class="profile-since">Miembro desde ${since}</div>
        <div class="profile-stats">
          <div class="profile-stat">
            <div class="profile-stat-n">${totalTournaments}</div>
            <div class="profile-stat-l">Torneos</div>
          </div>
          <div class="profile-stat">
            <div class="profile-stat-n" style="color:var(--green)">${totalWins}</div>
            <div class="profile-stat-l">Victorias</div>
          </div>
          <div class="profile-stat">
            <div class="profile-stat-n" style="color:var(--sand)">${totalPts}</div>
            <div class="profile-stat-l">Puntos totales</div>
          </div>
          <div class="profile-stat">
            <div class="profile-stat-n">${FOLLOWS.size}</div>
            <div class="profile-stat-l">Siguiendo</div>
          </div>
        </div>
      </div>
    </div>
    <div>
      <div class="card" style="margin-bottom:1rem">
        <div class="card-title">EstadÃ­sticas por nombre</div>
        ${stats.length ? `
          <table class="hist-table">
            <thead><tr>
              <th>Nombre en torneo</th>
              <th>Torneos</th>
              <th>Victorias</th>
              <th>Puntos</th>
            </tr></thead>
            <tbody>
              ${stats.map(s => `
                <tr>
                  <td class="hist-name">${s.player_name}</td>
                  <td>${s.tournaments || 0}</td>
                  <td style="color:var(--green)">${s.wins || 0}</td>
                  <td style="color:var(--accent);font-weight:700">${s.total_qpts || 0}</td>
                </tr>`).join('')}
            </tbody>
          </table>
        ` : `
          <div class="empty" style="padding:2rem">
            <div class="empty-icon">ğŸ¯</div>
            <div class="empty-title">Sin estadÃ­sticas aÃºn</div>
            <p style="font-size:12px;margin-top:4px">Tus stats aparecerÃ¡n aquÃ­ cuando los organizadores vinculen tu cuenta</p>
          </div>`}
      </div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTORIAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderHistory() {
  const container = document.getElementById('history-list');
  container.innerHTML = '<div class="loading"><div class="spinner"></div> Cargando...</div>';

  // Load event registrations for this user
  const regs = await dbGet(
    `event_registrations?user_id=eq.${CUR_USER.id}&select=*,tournament_events(title,date,location,users(club_name,username))&order=created_at.desc`
  );

  if (!regs.length) {
    container.innerHTML = `
      <div class="empty">
        <div class="empty-icon">ğŸ“</div>
        <div class="empty-title">Sin torneos registrados</div>
        <p>InscrÃ­bete en torneos desde tu feed para verlos aquÃ­</p>
      </div>`;
    return;
  }

  container.innerHTML = `
    <div class="card">
      <table class="hist-table">
        <thead><tr>
          <th>Torneo</th>
          <th>Club</th>
          <th>Fecha</th>
          <th>Estado</th>
        </tr></thead>
        <tbody>
          ${regs.map(r => {
            const ev = r.tournament_events;
            const club = ev?.users?.club_name || ev?.users?.username || 'â€”';
            const statusMap = {
              pending:   '<span class="badge badge-soon">Pendiente</span>',
              confirmed: '<span class="badge badge-open">Confirmado</span>',
              cancelled: '<span class="badge badge-cancel">Cancelado</span>',
            };
            return `<tr>
              <td class="hist-name">${ev?.title || 'â€”'}</td>
              <td style="color:var(--ink4)">${club}</td>
              <td style="color:var(--ink4)">${fmtDate(ev?.date)}</td>
              <td>${statusMap[r.status] || r.status}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>`;
}
</script>
</body>
</html>
